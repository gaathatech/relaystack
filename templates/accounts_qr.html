{% extends 'base.html' %}

{% block title %}Scan WhatsApp QR — {{ account_id }}{% endblock %}

{% block content %}
  <div class="card mx-auto" style="max-width:640px">
    <div class="card-body text-center">
      <h5 class="card-title">Scan WhatsApp QR</h5>
      <p class="small text-muted">Open WhatsApp on your phone → Settings → Linked Devices → Link a Device and scan the QR below.</p>

      {% if qr_image %}
        <img id="qr-img" src="{{ qr_image }}" alt="WhatsApp QR" class="img-fluid" style="max-height:480px;border-radius:8px;" />
      {% else %}
        <div id="qr-fallback" class="alert alert-warning">Unable to load QR. Try again or open login from accounts list.</div>
      {% endif %}

      <div class="mt-3">
        <a class="btn btn-secondary" href="{{ url_for('accounts_list') }}">Back to Accounts</a>
        <a class="btn btn-primary" id="refresh-btn">Refresh QR</a>
      </div>

      <div class="mt-3">
        <div id="status" class="badge bg-danger">Not logged in</div>
      </div>
    </div>
  </div>

<script>
const statusEl = document.getElementById('status');
const qrImg = document.getElementById('qr-img');

async function refreshQr(){
  try{
    const r = await fetch('{{ url_for('accounts_qr_image', provider=provider, account_id=account_id) }}');
    const j = await r.json();
    if(j.qr && qrImg){ qrImg.src = j.qr; }
    if(j.qr && document.getElementById('qr-fallback')){ document.getElementById('qr-fallback').remove(); }
  }catch(e){ console.log('refreshQr error', e); }
}

async function pollStatus(){
  try{
    const r = await fetch('{{ url_for('accounts_login_status', provider=provider, account_id=account_id) }}');
    const j = await r.json();
    if(j.ready){
      statusEl.textContent = 'Logged in';
      statusEl.className = 'badge bg-success';
      // stop further polling by clearing interval
      clearInterval(pollInterval);
      // redirect back to accounts list after short delay
      setTimeout(()=>{ window.location = '{{ url_for('accounts_list') }}'; }, 1200);
    } else {
      statusEl.textContent = 'Not logged in';
      statusEl.className = 'badge bg-danger';
    }
  }catch(e){ console.log('pollStatus error', e); }
}

document.getElementById('refresh-btn').addEventListener('click', function(e){ e.preventDefault(); refreshQr(); });

// Poll every 3s and refresh QR every 6s
const pollInterval = setInterval(pollStatus, 3000);
setInterval(refreshQr, 6000);
// initial calls
refreshQr();
pollStatus();
</script>
{% endblock %}
