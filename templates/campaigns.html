{% extends "base.html" %}

{% block title %}Campaigns - Nexora{% endblock %}

{% block content %}
<div class="page-title"><i class="fas fa-envelope"></i> Marketing Campaigns</div>

<button class="btn btn-primary mb-4" data-bs-toggle="modal" data-bs-target="#newCampaignModal">
    <i class="fas fa-plus"></i> New Campaign
</button>

<div class="table-responsive">
    <table class="table table-hover">
        <thead class="table-light">
            <tr>
                <th>Campaign Name</th>
                <th>Status</th>
                <th>Sent</th>
                <th>Delivered</th>
                <th>Failed</th>
                <th>Success Rate</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="campaignsTable">
            <tr><td colspan="7" class="text-center">Loading...</td></tr>
        </tbody>
    </table>
</div>

<!-- New Campaign Modal -->
<div class="modal fade" id="newCampaignModal" size="lg">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Campaign</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Campaign Name</label>
                    <input type="text" class="form-control" id="campaignName" placeholder="e.g. Q4 Product Launch">
                </div>
                <div class="mb-3">
                    <label class="form-label">Message Template</label>
                    <textarea class="form-control" id="messageTemplate" rows="4" placeholder="Use {name}, {phone}, {company}, {date}, {time} for variables"></textarea>
                </div>
                <div class="alert alert-info">
                    <strong>Available Variables:</strong>
                    <code>{name}</code>, <code>{phone}</code>, <code>{company}</code>, <code>{date}</code>, <code>{time}</code>
                </div>
                <div class="mb-3">
                    <label class="form-label">Select Contacts</label>
                    <select class="form-select" id="campaignContacts" multiple>
                        <option value="">Loading...</option>
                    </select>
                    <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">When to send?</label>
                    <div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="sendTime" id="sendNow" value="now" checked>
                            <label class="form-check-label">Send Now</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="sendTime" id="sendScheduled" value="scheduled">
                            <label class="form-check-label">Schedule For Later</label>
                        </div>
                    </div>
                </div>
                <div class="mb-3" id="scheduleDiv" style="display:none;">
                    <label class="form-label">Schedule Date & Time</label>
                    <input type="datetime-local" class="form-control" id="scheduleTime">
                </div>
                <button class="btn btn-success" onclick="createCampaign()"><i class="fas fa-rocket"></i> Create Campaign</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
function loadCampaigns() {
    axios.get('/api/campaigns')
        .then(res => {
            const html = res.data.campaigns.map(c => {
                const rate = c.sent > 0 ? ((c.delivered / c.sent) * 100).toFixed(1) : 'N/A';
                return `
                <tr>
                    <td><strong>${c.campaign_name}</strong></td>
                    <td><span class="badge bg-info">${c.status}</span></td>
                    <td>${c.sent_count}</td>
                    <td>${c.delivered_count || 0}</td>
                    <td>${c.failed_count || 0}</td>
                    <td>${rate}%</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewDetails(${c.id})"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-warning" onclick="previewMessage(${c.id})"><i class="fas fa-preview"></i></button>
                        <button class="btn btn-sm btn-primary" onclick="sendNow(${c.id})"><i class="fas fa-paper-plane"></i></button>
                    </td>
                </tr>
            `}).join('');
            document.getElementById('campaignsTable').innerHTML = html;
        });
}

function loadContacts() {
    axios.get('/api/contacts')
        .then(res => {
            const select = document.getElementById('campaignContacts');
            select.innerHTML = res.data.contacts.map(c => 
                `<option value="${c.id}">${c.name} (${c.phone_number})</option>`
            ).join('');
        });
}

document.getElementById('sendScheduled').addEventListener('change', () => {
    document.getElementById('scheduleDiv').style.display = 'block';
});

document.getElementById('sendNow').addEventListener('change', () => {
    document.getElementById('scheduleDiv').style.display = 'none';
});

function createCampaign() {
    const name = document.getElementById('campaignName').value;
    const template = document.getElementById('messageTemplate').value;
    const contactIds = Array.from(document.getElementById('campaignContacts').selectedOptions).map(o => o.value);
    const sendTime = document.getElementById('sendNow').checked ? 'now' : document.getElementById('scheduleTime').value;
    
    axios.post('/api/campaigns', {campaign_name: name, message_template: template})
        .then(res => {
            const cid = res.data.campaign_id;
            axios.post(`/api/campaigns/${cid}/contacts`, {contact_ids: contactIds})
                .then(() => {
                    if(sendTime === 'now') {
                        axios.post(`/api/campaigns/${cid}/send`)
                            .then(() => { alert('Campaign sent!'); loadCampaigns(); });
                    } else {
                        axios.post(`/api/campaigns/${cid}/schedule`, {schedule_time: sendTime})
                            .then(() => { alert('Campaign scheduled!'); loadCampaigns(); });
                    }
                });
        });
    document.getElementById('newCampaignModal').close();
}

function previewMessage(id) {
    axios.get(`/api/campaigns/${id}/preview`)
        .then(res => alert('Preview:\n\n' + res.data.preview));
}

function sendNow(id) {
    if(confirm('Send campaign now?')) {
        axios.post(`/api/campaigns/${id}/send`)
            .then(() => { alert('Campaign sent!'); loadCampaigns(); });
    }
}

function viewDetails(id) {
    axios.get(`/api/campaigns/${id}`)
        .then(res => {
            const c = res.data.campaign;
            alert(`Campaign: ${c.campaign_name}\nSent: ${c.sent_count}\nDelivered: ${c.delivered_count}\nFailed: ${c.failed_count}`);
        });
}

loadCampaigns();
loadContacts();
</script>
{% endblock %}
