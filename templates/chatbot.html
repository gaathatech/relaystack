{% extends "base.html" %}

{% block title %}Chatbot - Nexora{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-9">
        <div class="page-title"><i class="fas fa-robot"></i> AI Chatbot</div>
        
        <div class="card">
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Select App Type</label>
                    <select class="form-select" id="appType" onchange="switchApp()">
                        <option value="general">General Q&A</option>
                        <option value="nexora_business">Nexora Business Suite</option>
                        <option value="nexora_investments">Nexora Investments</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Your Phone Number</label>
                    <input type="tel" class="form-control" id="phoneNumber" placeholder="+1 (555) 000-0000">
                </div>

                <div style="height: 400px; border: 1px solid #ccc; border-radius: 8px; overflow-y: auto; padding: 15px; background: #f8f9fa;" id="chatBox">
                    <p class="text-muted text-center">Chat history will appear here...</p>
                </div>

                <div class="input-group mt-3">
                    <input type="text" class="form-control" id="messageInput" placeholder="Ask a question..." onkeypress="handleKeyPress(event)">
                    <button class="btn btn-primary" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>

                <div class="mt-2">
                    <button class="btn btn-sm btn-success" onclick="exportChat()"><i class="fas fa-download"></i> Export as PDF</button>
                    <button class="btn btn-sm btn-warning" onclick="clearChat()"><i class="fas fa-trash"></i> Clear History</button>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-layer-group"></i> Menu</h5>
            </div>
            <div class="card-body" id="menuBox">
                <p class="text-muted text-center">Select an app type to see menu</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
let conversationHistory = [];

function sendMessage() {
    const msg = document.getElementById('messageInput').value;
    const phone = document.getElementById('phoneNumber').value || 'anonymous';
    
    if(!msg.trim()) return;
    
    addToChatUI('You', msg, 'user');
    document.getElementById('messageInput').value = '';
    
    axios.post('/api/chat', {user_message: msg, contact_phone: phone})
        .then(res => {
            const r = res.data;
            addToChatUI('Bot', r.response, 'bot', r.confidence);
            conversationHistory.push({user: msg, bot: r.response, confidence: r.confidence});
        });
}

function addToChatUI(sender, msg, type, confidence = null) {
    const chatBox = document.getElementById('chatBox');
    const alignClass = type === 'user' ? 'text-end' : 'text-start';
    const bgClass = type === 'user' ? 'bg-primary text-white' : 'bg-light';
    
    let html = `
        <div class="mb-2 ${alignClass}">
            <div class="d-inline-block p-2 rounded" style="max-width: 80%; background-color: ${type === 'user' ? '#667eea' : '#e9ecef'}; color: ${type === 'user' ? 'white' : 'black'};">
                ${msg}
    `;
    if(confidence && type === 'bot') {
        html += `<br><small style="opacity: 0.8;">Confidence: ${(confidence * 100).toFixed(0)}%</small>`;
    }
    html += `</div></div>`;
    
    chatBox.innerHTML += html;
    chatBox.scrollTop = chatBox.scrollHeight;
}

function handleKeyPress(e) {
    if(e.key === 'Enter') sendMessage();
}

function switchApp() {
    const app = document.getElementById('appType').value;
    const menuBox = document.getElementById('menuBox');
    
    if(app === 'general') {
        menuBox.innerHTML = '<p class="text-muted">Ask me anything about Nexora apps!</p>';
    } else {
        axios.get(`/api/ivr/${app}/menu`)
            .then(res => {
                const items = res.data.options || [];
                menuBox.innerHTML = items.map((opt, i) => 
                    `<button class="btn btn-sm btn-outline-primary w-100 mb-2" onclick="selectOption(${i})">${i+1}. ${opt}</button>`
                ).join('');
            });
    }
}

function selectOption(option) {
    const app = document.getElementById('appType').value;
    axios.get(`/api/ivr/${app}/${option}`)
        .then(res => {
            addToChatUI('Bot', res.data.response, 'bot');
        });
}

function exportChat() {
    const phone = document.getElementById('phoneNumber').value || 'anonymous';
    window.location.href = `/api/export/chat-history/${phone}`;
}

function clearChat() {
    if(confirm('Clear chat history?')) {
        document.getElementById('chatBox').innerHTML = '<p class="text-muted text-center">Chat cleared</p>';
        conversationHistory = [];
    }
}

switchApp();
</script>
{% endblock %}
