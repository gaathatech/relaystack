{% extends 'base.html' %}

{% block title %}RelayStack ‚Äî WhatsApp Bulk Messaging{% endblock %}

{% block content %}
  {% if error %}
    <div class="note">‚ùå {{ error }}</div>
  {% endif %}

    <form method="post">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-2">
                    <label class="form-label">Paste Numbers (one per line):</label>
                    <textarea class="form-control" name="numbers" rows="12" placeholder="e.g. 919876543210">{{ request.form.get('numbers','') }}</textarea>
                </div>

        {%- if request.form.get('provider','whatsapp') == 'whatsapp' %}
        <div class="mb-2">
          <label class="form-label">Select WhatsApp account</label>
          <select class="form-select" name="account_id">
              {% for acc in (accounts or []) %}
                  <option value="{{ acc.account_id }}" {% if request.form.get('account_id','default')==acc.account_id %}selected{% endif %}>{{ acc.account_id }}</option>
              {% endfor %}
              <option value="default" {% if request.form.get('account_id','default')=='default' %}selected{% endif %}>default</option>
          </select>
        </div>
        {%- endif %}
      </div>
            <div class="col-md-6">
                <div class="mb-2">
                    <label class="form-label">Platform / Provider:</label>
                    <select class="form-select" name="provider">
                            <option value="whatsapp" selected>WhatsApp (default)</option>
                    </select>
                </div>

                <div class="mb-2 small text-muted"> 
                        <a href="/accounts">Manage accounts</a> &middot; Create an account and click "Start login" to open WhatsApp Web QR for that profile.
                </div>

                <div class="mb-2">
                    <label class="form-label">Message:</label>
                    <textarea class="form-control" name="message" rows="6" placeholder="Type your message here...">{{ request.form.get('message','') }}</textarea>
                </div>

                <div class="d-flex gap-2 align-items-center">
                        <button name="action" value="Start" type="submit" class="btn btn-success">Start Sending</button>
                        <button class="btn btn-outline-secondary" name="action" value="Stop" type="submit">Stop Sending</button>
                </div>

        <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" id="preserve_session" name="preserve_session" {% if request.form.get('preserve_session') %}checked{% endif %}>
            <label class="form-check-label" for="preserve_session">Preserve WhatsApp session after send</label>
        </div>

        <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="consent" name="consent" {% if request.form.get('consent') %}checked{% endif %}>
            <label class="form-check-label" for="consent">I confirm I have consent from recipients to receive messages</label>
        </div>

        <div style="margin-top:12px">
            <div id="whatsapp-status" class="badge disconnected">WhatsApp: checking‚Ä¶</div>
        </div>

        <script>
        function updateStatus(){
            fetch('/status/whatsapp').then(r => r.json()).then(data => {
                const el = document.getElementById('whatsapp-status');
                if(data.ready){
                    el.textContent = 'WhatsApp: Ready';
                    el.className = 'badge connected';
                } else {
                    el.textContent = 'WhatsApp: Not ready';
                    el.className = 'badge disconnected';
                }
            }).catch(err => {
                const el = document.getElementById('whatsapp-status');
                el.textContent = 'WhatsApp: Error';
                el.className = 'badge disconnected';
            });
        }
        document.addEventListener('DOMContentLoaded', function(){ updateStatus(); setInterval(updateStatus, 5000); });
        </script>

        <div style="margin-top:8px">
            <span id="sending-status" class="badge"></span>
        </div>
        <script src="/static/js/sending_status.js"></script>

        {% if uploaded %}
            <div class="status">{{ status or 'Status: Sending in background' }}
                <div class="download-link"><a href="{{ url_for('static', filename='logs/' + log_file) }}" download>üì• Download Message Log (Excel)</a></div>
            </div>
        {% elif status %}
            <div class="status">{{ status }}</div>
        {% endif %}

        {%- if request.form.get('provider','whatsapp') == 'whatsapp' %}
            <div class="small" style="margin-top:8px;color:#b91c1c">Note: By default the app clears the WhatsApp session after the send, requiring a QR scan next time. Use the "Preserve WhatsApp session after send" checkbox above if you want to keep the session for the next run.</div>
        {%- elif request.form.get('provider','whatsapp') != 'whatsapp' %}
            <div class="small" style="margin-top:8px;color:#6b7280">Note: The selected provider is not implemented yet. Choosing WhatsApp is recommended for now.</div>
        {%- endif %}
      </div>
    </div>
  </form>
{% endblock %}
